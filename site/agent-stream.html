<!DOCTYPE html>
<html lang="en">
<head>
    <title>GAA-4.0 Agent Conversation Stream</title>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Mono', Monaco, monospace;
            background: #0d1117;
            color: #c9d1d9;
            padding: 1rem;
        }
        
        .header {
            background: #161b22;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        
        h1 { color: #58a6ff; font-size: 1.5rem; }
        .subtitle { color: #8b949e; margin-top: 0.5rem; }
        
        .conversation {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 1rem;
            height: calc(100vh - 150px);
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 1.5rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .agent-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .planner { color: #7ee83f; }
        .reviewer { color: #ffa657; }
        .executor { color: #ff7b72; }
        .reflector { color: #a371f7; }
        .conversation-agent { color: #58a6ff; }
        .system { color: #8b949e; }
        
        .content {
            background: #161b22;
            border-left: 3px solid;
            padding: 0.75rem;
            border-radius: 4px;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .planner-content { border-color: #7ee83f; }
        .reviewer-content { border-color: #ffa657; }
        .executor-content { border-color: #ff7b72; }
        .reflector-content { border-color: #a371f7; }
        .conversation-content { border-color: #58a6ff; }
        .system-content { border-color: #8b949e; }
        
        .timestamp {
            font-size: 0.75rem;
            color: #6e7681;
            margin-top: 0.5rem;
        }
        
        .error {
            color: #f85149;
            font-weight: bold;
        }
        
        .success {
            color: #3fb950;
        }
        
        .warning {
            color: #d29922;
        }
        
        .loop-marker {
            text-align: center;
            margin: 2rem 0;
            color: #58a6ff;
            font-weight: bold;
            border-top: 1px solid #30363d;
            border-bottom: 1px solid #30363d;
            padding: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ¤– Agent Conversation Stream</h1>
        <div class="subtitle">Real-time agent-to-agent communications (human-interesting parts only)</div>
    </div>
    
    <div class="conversation" id="conversation">
        <!-- Messages will appear here -->
    </div>
    
    <script>
        let lastLoopId = null;
        
        // Connect to SSE
        const eventSource = new EventSource('/events');
        
        eventSource.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'activity' && data.data) {
                processActivity(data.data);
            }
        };
        
        function processActivity(activity) {
            const container = document.getElementById('conversation');
            
            // Add loop marker if new loop
            if (activity.loopId && activity.loopId !== lastLoopId) {
                if (activity.action === 'Loop started') {
                    const marker = document.createElement('div');
                    marker.className = 'loop-marker';
                    marker.textContent = `â”â”â” LOOP ${JSON.parse(activity.details).loopNumber} STARTED â”â”â”`;
                    container.appendChild(marker);
                    lastLoopId = activity.loopId;
                }
            }
            
            // Filter for interesting content
            const interesting = [
                'Plan generated',
                'Plan details',
                'Review complete',
                'Execution complete',
                'Reflection complete',
                'Responding to human',
                'Plan generation failed',
                'Loop failed'
            ];
            
            if (!interesting.some(i => activity.action.includes(i))) {
                return; // Skip uninteresting events
            }
            
            const message = document.createElement('div');
            message.className = 'message';
            
            // Parse details
            let content = '';
            try {
                const details = typeof activity.details === 'string' ? 
                    JSON.parse(activity.details) : activity.details;
                
                if (details) {
                    if (details.spec_preview) {
                        content = `PLAN:\n${details.spec_preview}...\nSteps: ${details.steps || 0}`;
                    } else if (details.reflection) {
                        content = `REFLECTION:\n${details.reflection}`;
                    } else if (details.response) {
                        content = `RESPONSE TO HUMAN:\n${details.response}`;
                    } else if (details.approved !== undefined) {
                        content = `REVIEW RESULT:\nApproved ${details.approved} steps`;
                    } else if (details.error) {
                        content = `ERROR:\n${details.error}`;
                    } else {
                        content = JSON.stringify(details, null, 2);
                    }
                } else {
                    content = activity.action;
                }
            } catch (e) {
                content = activity.details || activity.action;
            }
            
            // Determine agent type for styling
            const agentClass = activity.agent.toLowerCase().replace('agent', '');
            
            message.innerHTML = `
                <div class="agent-name ${agentClass}">${activity.agent}</div>
                <div class="content ${agentClass}-content">${content}</div>
                <div class="timestamp">${new Date(activity.timestamp).toLocaleTimeString()}</div>
            `;
            
            container.appendChild(message);
            
            // Auto scroll to bottom
            container.scrollTop = container.scrollHeight;
            
            // Limit messages to last 100
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }
        
        // Load recent activities on page load
        fetch('/api/activities?limit=50')
            .then(res => res.json())
            .then(activities => {
                activities.reverse().forEach(processActivity);
            });
    </script>
</body>
</html>